<!DOCTYPE html>

<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Bouletta ‚Äî —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç‚Äë–º–∞–≥–∞–∑–∏–Ω</title>
<meta content="–®–∫—ñ—Ä—è–Ω—ñ —Å—É–º–∫–∏ —Ç–∞ –∞–∫—Å–µ—Å—É–∞—Ä–∏ Bouletta. –û—Ñ—ñ—Ü—ñ–π–Ω–∏–π –∫–∞—Ç–∞–ª–æ–≥, —à–≤–∏–¥–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∞, –±–µ–∑–ø–µ—á–Ω–∞ –æ–ø–ª–∞—Ç–∞." name="description"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&amp;display=swap" rel="stylesheet"/>
<style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#16181d;--muted:#6b7280;--primary:#2563eb;--border:#e5e7eb;--accent:#111827}
    *{box-sizing:border-box}
    html{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;scroll-behavior:smooth}
    body{margin:0;background:var(--bg);color:var(--text);font-size:clamp(14px,2.3vw,16px);line-height:1.5}
    img{max-width:100%;display:block}
    button{font:inherit}
    a{color:inherit}

    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;gap:12px;align-items:center;z-index:30}
    header h1{font-size:clamp(16px,4.5vw,20px);margin:0;font-weight:800;letter-spacing:.2px;white-space:nowrap}
    .spacer{flex:1}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--accent);padding:10px 14px;border-radius:12px;font-weight:650;cursor:pointer;line-height:1}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff;border-radius:10px;transition:background-color .25s,box-shadow .25s,transform .2s}
    .btn.primary:hover{
      background:#1e4fd9;
      box-shadow:0 6px 14px rgba(37,99,235,.25);
      transform:translateY(-1px);
    }
    .btn.primary:active{
      background:#1b46c7;
      transform:none;
      box-shadow:0 2px 8px rgba(37,99,235,.2);
    }
     .btn.icon{display:inline-flex;gap:8px;align-items:center}

    .toolbar{display:grid;gap:10px;padding:12px 16px;background:#fff;border-bottom:1px solid var(--border);grid-template-columns:1fr 1fr 1fr}
    @media(max-width:1100px){.toolbar{grid-template-columns:1fr 1fr}}
    @media(max-width:640px){.toolbar{grid-template-columns:1fr}}
    .label{font-size:12px;color:var(--muted)}
    .input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}

    .container{padding:14px;display:grid;gap:14px;grid-template-columns:repeat(4,1fr)}
    @media(max-width:1200px){.container{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:860px){.container{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:560px){.container{grid-template-columns:1fr;padding:12px}}

    .card{background:var(--card);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 6px 20px rgba(17,24,39,.06)}
    .card .body{padding:12px}
    .card .name{font-weight:800;margin:0 0 4px;font-size:clamp(14px,4vw,16px);line-height:1.25}
    .card .barcode{font-size:12px;color:var(--muted);}
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;font-size:13px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#fafafa;white-space:nowrap}
    .prices{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    @media(max-width:560px){.prices{grid-template-columns:1fr}}
    .price-block{border:1px solid var(--border);border-radius:12px;padding:8px;background:#fafbff}
    .retail-block{background:#eef2ff}.wholesale-block{background:#ecfdf5}
    .price-title{font-size:12px;font-weight:800;color:var(--accent);margin-bottom:4px;text-transform:uppercase}
    .pill{display:inline-block;font-variant-numeric:tabular-nums;padding:7px 10px;border-radius:10px;border:1px solid #e6e8ef;font-weight:700}
    .card .footer{margin-top:auto;padding:10px 12px;border-top:1px solid var(--border);display:flex;gap:10px}
    /* –µ—Ñ–µ–∫—Ç –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Ç—ñ–Ω–Ω—é –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –Ω–∞ –∫–∞—Ä—Ç–∫—É —Ç–æ–≤–∞—Ä—É */
    .card {
      transition: transform .25s ease, box-shadow .25s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,.06);
    }
    .card:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      cursor: pointer;
    }

    .slider{position:relative;aspect-ratio:4/3;overflow:hidden}
    .slides{display:flex;height:100%;overflow-x:auto;scroll-snap-type:x mandatory;scroll-behavior:smooth;gap:0;-webkit-overflow-scrolling:touch;scrollbar-width:none}
    .slides::-webkit-scrollbar{display:none}
    .slide{min-width:100%;position:relative;flex:0 0 100%;scroll-snap-align:center}
    .slide img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#fff}

    .status{padding:0 16px 10px;color:var(--muted);font-size:13px}

    #cart{position:fixed;top:0;right:-420px;width:380px;max-width:96vw;height:100vh;background:#fff;border-left:1px solid var(--border);box-shadow:-8px 0 30px rgba(0,0,0,.08);transition:right .25s;display:flex;flex-direction:column;z-index:50}
    #cart.open{right:0}
    #cart .head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    #cart .body{padding:10px 12px;flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .cart-item{display:grid;grid-template-columns:56px minmax(0,1fr) auto;gap:10px;align-items:start;border:1px solid var(--border);border-radius:12px;padding:8px}
    .cart-item img{width:56px;height:56px;object-fit:cover;border-radius:8px;grid-row:1/span 3}
    .qty{display:inline-flex;align-items:center;gap:6px;margin-top:6px}
    .qty input{width:48px;text-align:center;padding:6px;border:1px solid var(--border);border-radius:8px}
    #cart .foot{padding:12px;border-top:1px solid var(--border)}

    /* === Checkout Drawer === */
    #checkout{position:fixed;bottom:0;left:0;right:0;max-height:92vh;background:#fff;border-top:1px solid var(--border);box-shadow:0 -8px 30px rgba(0,0,0,.08);transform:translateY(100%);transition:transform .25s ease;z-index:60}
    #checkout.open{transform:none}
    .ck-head{display:flex;gap:8px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
    .ck-body{padding:12px 14px;display:grid;gap:14px}
    .step{border:1px solid var(--border);border-radius:12px;padding:12px}
    .step h4{margin:0 0 8px;font-size:14px}
    .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    .hint{font-size:12px;color:var(--muted)}
    .total{font-weight:800}
    .ok{color:#059669}.bad{color:#b91c1c}
    .tag{display:inline-block;border:1px dashed var(--border);padding:2px 8px;border-radius:999px;font-size:12px}
#checkout{
  display:flex;                /* –¥–æ–∑–≤–æ–ª—è—î –∫–µ—Ä—É–≤–∞—Ç–∏ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—é –≤–∏—Å–æ—Ç–æ—é */
  flex-direction:column;
  max-height:100svh;           /* –≤—Ä–∞—Ö–æ–≤—É—î –º–æ–±—ñ–ª—å–Ω—ñ –ø–∞–Ω–µ–ª—ñ */
}
#checkout .ck-body{
  flex:1 1 auto;
  min-height:0;                /* —â–æ–± flex-–¥–∏—Ç–∏–Ω–∞ –º–æ–≥–ª–∞ —Å–∫—Ä–æ–ª–∏—Ç–∏—Å—è */
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
@media (max-width:560px){
  #checkout{
    border-top-left-radius:16px;
    border-top-right-radius:16px;
  }
}
    /* ==== Mobile polish ==== */
    @media (max-width: 560px){
      header{flex-wrap:wrap;gap:8px}
      .spacer{display:none}
      .card .footer{flex-direction:column}
      .btn{width:100%}
      .card .body{padding:10px}
      .card .footer{padding:10px}
    }
    @media (max-width: 400px){
      .card .barcode{display:none}
      .badge{padding:3px 8px;font-size:11px}
      .pill{padding:6px 8px;font-size:13px}
      .price-title{font-size:11px}
    }


/* ==== Slider UI (arrows + dots) ==== */
.slider{position:relative}
.slider .slides{scrollbar-width:none}
.slider .slides::-webkit-scrollbar{display:none}
.slider .nav{
  position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;
  pointer-events:none;padding:0 6px;
}
.slider .nav .arrow{
  pointer-events:auto;border:none;background:rgba(0,0,0,.25);color:#fff;border-radius:999px;
  width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;
  opacity:.6
}
.slider .nav .arrow:hover{opacity:.85}
.slider .dots{
  position:absolute;left:50%;bottom:8px;transform:translateX(-50%);display:flex;gap:6px;
  padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.25);backdrop-filter:blur(2px);
}
.slider .dots button{
  width:6px;height:6px;border-radius:50%;border:none;background:#ddd;opacity:.7;cursor:pointer;padding:0;display:block
}
.slider .dots button[aria-current="true"]{opacity:1;background:#fff;transform:scale(1.2)}



/* line clamp for cart titles */
.cart-item .title{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}


@media (max-width:560px){
  #cart{
    position:fixed;left:0;right:0;bottom:0;top:auto;width:100vw;max-width:none;
    height:70vh;max-height:80vh;transform:translateY(100%);
    transition:transform .25s ease;z-index:70;background:var(--panel,#fff);
    border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -8px 24px rgba(0,0,0,.15);
    display:flex;flex-direction:column;
  }
  #cart.open{transform:translateY(0)}
  #cart .head{flex:0 0 auto;position:sticky;top:0;background:inherit;z-index:1}
  #cart .body{flex:1 1 auto;min-height:0;overflow:auto;padding-bottom:10px}
  #cart .foot{flex:0 0 auto;position:sticky;bottom:0;background:inherit;padding-bottom:calc(env(safe-area-inset-bottom, 12px));}
  #cart .foot .row{display:flex;gap:8px;align-items:center}
  #cart .foot .spacer{display:none}
  #cart .foot .btn{flex:1 1 0;min-height:44px}
  #cart .foot .btn.primary{flex:1 1 0}

  /* Checkout drawer internals */
  #checkout .ck-head{position:sticky;top:0;background:var(--panel,#fff);z-index:1}
  #checkout .ck-body{max-height:min(calc(100vh - 140px),80vh);overflow:auto;padding-bottom:90px}
  .ck-actions{position:sticky;bottom:0;background:var(--panel,#fff);padding:10px 0;z-index:1;display:flex;gap:8px;align-items:center}
  .ck-actions .spacer{display:none}
  .ck-actions .btn{flex:1 1 0;min-height:44px}
}

@media (max-width:400px){
  #checkout .ck-body{padding-bottom:96px}
}


@media (max-width: 560px){
  #cart .foot{padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 12px) !important;}
  #cart .body{padding-bottom: 90px !important;}
}


@keyframes cart-bump { 0%{transform:scale(1)} 30%{transform:scale(1.15)} 100%{transform:scale(1)} }
#cartBtn.bump, #cartCount.bump { animation: cart-bump .35s ease; }

.fly-clone{
  position:fixed; z-index: 9999; pointer-events:none;
  transition: transform .6s cubic-bezier(.22,.61,.36,1), opacity .6s ease;
  will-change: transform, opacity;
}


/* Quick glow on cart button when item added */
@keyframes cart-glow {
  0% { box-shadow: 0 0 0 0 rgba(0,128,255,0); }
  30% { box-shadow: 0 0 0 6px rgba(0,128,255,.25); }
  100% { box-shadow: 0 0 0 0 rgba(0,128,255,0); }
}
#cartBtn.flash { animation: cart-bump .35s ease, cart-glow .6s ease; }


@media (max-width:560px){
  #cart .head{position:sticky;top:0;background:inherit;z-index:1}
  #cart .body{flex:1 1 auto;min-height:0;overflow:auto}
  #cart .foot{position:sticky;bottom:0;z-index:1;background:inherit}
  .ck-actions{position:sticky;bottom:0;z-index:1;background:inherit}
}


/* Center the cart button on mobile */
@media (max-width:560px){
  header{flex-wrap:wrap;justify-content:center;gap:8px}
  #cartBtn{order:2}
  #resetBtn{order:1}
}
#cartBtn .icon{display:inline-block;width:1em;height:1em;vertical-align:-0.15em;margin-right:6px}
#cartBtn .icon svg{width:1em;height:1em;display:block}


/* === Checkout actions pinned below content (no overlap) === */
:root{ --ck-actions-h: 64px; }
.ck-actions{ min-height: var(--ck-actions-h); }
#checkout .ck-body{ padding-bottom: calc(var(--ck-actions-h) + 24px); }

@media (max-width:560px){
  :root{ --ck-actions-h: 72px; }
  #checkout .ck-body{ padding-bottom: calc(var(--ck-actions-h) + env(safe-area-inset-bottom, 12px)); }
}


/* Ensure the cart button is perfectly centered on mobile */
@media (max-width:560px){
  header{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
  }
  #cartBtn{
    margin:8px auto;
    align-self:center;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #cartBtn .icon{margin-right:6px}
}


/* === Required field highlighting === */
.input.err, input.err, textarea.err, select.err{
  border-color:#ef4444 !important;
  box-shadow:0 0 0 2px rgba(239,68,68,.15) !important;
}
label.field.err .input{
  border-color:#ef4444 !important;
  box-shadow:0 0 0 2px rgba(239,68,68,.15) !important;
}


  /* === WHOLESALE BADGES === */
  .wholesale-flag{
    display:none;
    align-items:center;
    gap:8px;
    margin:6px 0 8px;
    padding:8px 10px;
    border-radius:10px;
    background: linear-gradient(90deg, rgba(16,185,129,.12), rgba(16,185,129,.06));
    border:1px solid rgba(16,185,129,.35);
    font-weight:600; font-size:12px;
  }
  .wholesale-flag:before{ content:"‚úì"; font-weight:700 }
  .wholesale-note{
    display:none;
    margin-top:8px;
    padding:8px 10px;
    border-radius:10px;
    background: linear-gradient(90deg, rgba(16,185,129,.12), rgba(16,185,129,.06));
    border:1px solid rgba(16,185,129,.35);
    font-size:12px; font-weight:600;
  }
</style>
<style id="desc-modal-styles">
/* === Description button (distinct from primary) === */
.btn.ghost{
  background:#fff;
  border:1px dashed var(--border);
  color:var(--accent);
  border-radius:12px;
  transition:background-color .2s, box-shadow .2s, transform .15s;
}
.btn.ghost:hover{ background:#f9fafb; box-shadow:0 2px 8px rgba(0,0,0,.06); transform:translateY(-1px) }
.btn.ghost:active{ transform:none; box-shadow:0 1px 4px rgba(0,0,0,.04) }

/* === Product modal (compact, animated) === */
#prodModalOverlay{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,.35); z-index:80; backdrop-filter:saturate(120%) blur(2px);
  transition:opacity .2s ease;
}
#prodModalOverlay.open{ display:flex; }
#prodModalOverlay .panel{
  width:min(680px, 92vw);
  max-height:80vh;
  overflow:auto;
  background:#fff;
  border-radius:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
  transform:scale(.96);
  opacity:0;
  transition:transform .18s ease, opacity .18s ease;
}
#prodModalOverlay.open .panel{ transform:scale(1); opacity:1 }

#prodModalOverlay .ph{
  display:flex; align-items:center; gap:8px;
  padding:12px 14px; border-bottom:1px solid var(--border);
}
#prodModalOverlay .pb{ padding:14px; display:grid; gap:10px; line-height:1.55; }
#prodModalOverlay .actions{ display:flex; gap:8px; justify-content:flex-end; padding:12px 14px; border-top:1px solid var(--border) }
#prodModalClose{ min-width:44px }
.desc-meta{ display:flex; flex-wrap:wrap; gap:8px; }
.desc-meta .badge{ background:#f8fafc }
.desc-prices{ display:flex; flex-wrap:wrap; gap:8px; }
</style>
<style id="flip-card-styles">
/* === Flip card for product description (safe version) === */
.card{
  perspective:1000px;
  --flip-h:auto;
}

.card .flip-inner{
  position:relative;
  transform-style:preserve-3d;
  width:100%;
  min-height:var(--flip-h);
  height:var(--flip-h);
  will-change:transform;
  transition:transform .44s cubic-bezier(.22,.61,.36,1);
  transform-origin:center center; /* —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π ‚Äú—à–∞—Ä–Ω—ñ—Ä‚Äù */
}

.product-card{
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

.product-info{
  margin-top:auto;
}

.card.flipped .flip-inner{
  transform:rotateY(180deg);
}

.card .front,
.card .back{
  position:absolute;
  inset:0;
  backface-visibility:hidden;
  -webkit-backface-visibility:hidden;
  display:flex;
  flex-direction:column;
  height:100%;
}

.card .front{
  z-index:2;
}

.card .back{
  transform:rotateY(180deg);
  background:var(--card,#fff);
  border-radius:16px;
  padding:12px;
  gap:10px;
  overflow:auto;
}

.desc-head{
  display:flex;
  gap:8px;
  align-items:center;
}

.desc-head .title{
  font-weight:800;
  line-height:1.25;
}

.desc-scroll{
  flex:1 1 auto;
  min-height:0;
  overflow:auto;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  background:#fafafa;
}

.desc-actions{
  display:flex;
  gap:8px;
  align-items:center;
}

.btn.back{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
}

.btn.back:hover{
  background:#f9fafb;
}

@media (max-width:560px){
  .card .flip-inner{
    min-height:var(--flip-h);
  }
}

/* –æ–±–∏–¥–≤—ñ —Å—Ç–æ—Ä–æ–Ω–∏ –∑–∞–π–º–∞—é—Ç—å –æ–¥–Ω–∞–∫–æ–≤—É –≤–∏—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.card{
  --flip-h:auto;
}

.card .flip-inner{
  width:100%;
  height:var(--flip-h);
  min-height:var(--flip-h);
}

/* –±–µ–∫ —Å–∫—Ä–æ–ª–∏—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ, –Ω–µ –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Ä–æ–∑–º—ñ—Ä –∫–∞—Ä—Ç–∫–∏ */
.card .back{
  overflow:auto;
}

button.desc-toggle img.desc-icon{
  width:28px;
  height:28px;
  object-fit:contain;
  display:block;
}
</style>
<style>
      #global-flip-back {
        position: fixed;
        top: 12px;
        left: 12px;
        z-index: 99999;
        padding: 10px 14px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        cursor: pointer;
        background: rgba(0,0,0,0.08);
        backdrop-filter: blur(2px);
        display: none;
      }
      body.has-flipped #global-flip-back { display: inline-block; }
    </style>
</head>

<body>
<header>
<h1>Bouletta ‚Äî –∫–∞—Ç–∞–ª–æ–≥</h1>
<div class="spacer"></div>
<button class="btn" id="resetBtn">–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</button>
<button class="btn icon" id="cartBtn">–ö–æ—à–∏–∫ (<span id="cartCount">0</span>)</button>
</header>

<section class="toolbar">
<div>
<div class="label">–¢–∏–ø —Ç–æ–≤–∞—Ä—É</div>
<select class="input" id="typeSel"><option value="">–í—Å—ñ</option></select>
</div>
<div>
<div class="label">–ö–æ–ª—ñ—Ä</div>
<select class="input" id="colorSel"><option value="">–í—Å—ñ</option></select>
</div>
<div>
<div class="label">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è</div>
<select class="input" id="sort">
<option value="name-asc">–ù–∞–∑–≤–∞ (–ê‚Üí–Ø)</option>
<option value="name-desc">–ù–∞–∑–≤–∞ (–Ø‚Üí–ê)</option>
<option value="retailUAH-asc">–†–æ–∑–¥—Ä—ñ–± UAH ‚Üë</option>
<option value="retailUAH-desc">–†–æ–∑–¥—Ä—ñ–± UAH ‚Üì</option>
<option value="wholesaleUAH-asc">–û–ø—Ç UAH ‚Üë</option>
<option value="wholesaleUAH-desc">–û–ø—Ç UAH ‚Üì</option>
</select>
</div>
</section>

<section class="toolbar" style="border-top:0">
  <div>
    <div class="label">–ö—É—Ä—Å USD ‚Üí UAH</div>
    <div class="row" style="display:flex;gap:8px;align-items:center">
      <input class="input" id="rateInput" inputmode="decimal" placeholder="–ù–∞–ø—Ä.: 41.00" style="max-width:150px">
      <button class="btn" id="btnUpdateRate">–û–Ω–æ–≤–∏—Ç–∏ (–ù–ë–£)</button>
    </div>
    <small class="hint" id="rateInfo">–ü–æ—Ç–æ—á–Ω–∏–π –∫—É—Ä—Å: 41.00</small>
  </div>

  <div>
    <div class="label">–ï–∫—Å–ø–æ—Ä—Ç</div>
    <div class="row" style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="exportXLSX">Excel</button>
    </div>
    <small class="hint">–ï–∫—Å–ø–æ—Ä—Ç –ø–æ—Ç–æ—á–Ω–æ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤</small>
  </div>

  <div>
    <div class="label">–ü—Ä–æ–º–æ–∫–æ–¥</div>
    <div class="row" style="display:flex;gap:8px;align-items:center">
      <input class="input" id="promo" placeholder="–ù–∞–ø—Ä.: BOULETTA5" style="max-width:160px">
      <span id="promoState" class="hint tag">–Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ</span>
    </div>
<!--    <small class="hint">–î—ñ—é—Ç—å –∫–æ–¥–∏ WELCOME5, VIP10</small>-->
  </div>
</section>

<div class="status" id="status"></div>

<section class="container" id="grid"></section>
<!-- –ö–æ—à–∏–∫ -->
<aside id="cart">
<div class="head">
<strong style="font-size:14px">–í–∞—à –∫–æ—à–∏–∫</strong>
<div class="spacer"></div>
<button class="btn" id="closeCart">‚úï</button>
</div>
<div class="body" id="cartList"></div>
<div class="foot">
<div class="row" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0"><span>–†–∞–∑–æ–º</span><b id="cartTotal">0 –≥—Ä–Ω ‚Ä¢ $0</b></div>
<div class="row" style="display:flex;gap:8px;align-items:center">
<button class="btn" id="cartClear">–û—á–∏—Å—Ç–∏—Ç–∏</button>
<div class="spacer"></div>
<button class="btn primary" id="checkoutBtn">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
</div>
</div>
</aside>
<!-- –ß–µ–∫–∞—É—Ç -->
<section aria-hidden="false" id="checkout">
<div class="ck-head">
<strong>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</strong>
<div class="spacer"></div>
<button class="btn" id="closeCheckout">–ó–≥–æ—Ä–Ω—É—Ç–∏</button>
</div>
<div class="ck-body">
<!-- –ö–†–û–ö 1: –ö–æ–Ω—Ç–∞–∫—Ç–∏ -->
<div class="step">
<h4>1) –ö–æ–Ω—Ç–∞–∫—Ç–∏</h4>
<div class="grid">
<label class="field"><span>–Ü–º‚Äô—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ*</span><input class="input" id="fName" placeholder="–û–ª–µ–∫—Å—ñ–π –Ü–≤–∞–Ω–µ–Ω–∫–æ" required=""/></label>
<label class="field"><span>–¢–µ–ª–µ—Ñ–æ–Ω*</span><input class="input" id="fPhone" placeholder="+380" required=""/></label>
<label class="field"><span>Email</span><input class="input" id="fEmail" placeholder="name@email.com"/></label>
<label class="field"><span>–ö–æ–º–µ–Ω—Ç–∞—Ä</span><input class="input" id="fNote" placeholder="–ü–æ–±–∞–∂–∞–Ω–Ω—è –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"/></label>
</div>
<small class="hint">–ü–æ–∑–Ω–∞—á–µ–Ω—ñ * –ø–æ–ª—è ‚Äî –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ.</small>
</div>

<!-- –ö–†–û–ö 2: –î–æ—Å—Ç–∞–≤–∫–∞ -->
<div class="step">
<h4>2) –î–æ—Å—Ç–∞–≤–∫–∞</h4>
<div class="grid">
<label class="field"><span>–°–ø–æ—Å—ñ–±*</span>
<select class="input" id="fShip">
<option value="nova">–ù–æ–≤–∞ –ü–æ—à—Ç–∞ (–≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è)</option>
<option value="np_courier">–ù–æ–≤–∞ –ü–æ—à—Ç–∞ (–∫—É—Ä‚Äô—î—Ä)</option>
<option value="meest">Meest</option>
<option value="pickup">–°–∞–º–æ–≤–∏–≤—ñ–∑</option>
</select>
</label>

<label class="field"><span>–ú—ñ—Å—Ç–æ*</span><input class="input" id="fCity" placeholder="–ö–∏—ó–≤" required=""/></label>
<label class="field"><span>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è/–ê–¥—Ä–µ—Å–∞*</span><input class="input" id="fAddress" placeholder="‚Ññ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –∞–±–æ –∞–¥—Ä–µ—Å–∞" required=""/></label>
<div></div>
</div>
</div>

<!-- –ö–†–û–ö 3: –û–ø–ª–∞—Ç–∞ —Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è -->
<div class="step">
<h4>3) –û–ø–ª–∞—Ç–∞</h4>
<div class="grid">
<label class="field"><span>–ú–µ—Ç–æ–¥*</span>
<select class="input" id="fPay">
<option value="prepay">–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (200 –≥—Ä–Ω)</option>
<option value="full">–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞</option>
</select>
</label>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
<small class="hint">–ü—ñ–¥—Å—É–º–æ–∫: <span id="ckItems">0 —Ç–æ–≤–∞—Ä—ñ–≤</span></small>
<div><span class="hint">–î–æ —Å–ø–ª–∞—Ç–∏</span> <span class="total" id="ckTotal">0 –≥—Ä–Ω</span></div>
</div>
<div class="ck-actions" style="display:flex;gap:8px;align-items:center;margin-top:10px">
<button class="btn" id="backToCart">‚Üê –î–æ –∫–æ—à–∏–∫–∞</button>
<div class="spacer"></div>
<button class="btn primary" id="placeOrderBtn">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
</div>
<small class="hint" id="submitState"></small>
</div>
</div>
</section>

<template id="cardTpl"><article class="card">
<div class="media"><div class="slider"><div class="slides"></div></div></div>
<div class="body">
<h3 class="name"></h3>
<div class="barcode"></div>
<div class="meta"><span class="type badge"></span><span class="color badge"></span></div>
<div class="prices">
<div class="price-block retail-block"><div class="price-title">–†–æ–∑–¥—Ä—ñ–±</div><div class="price-row"><span class="pill retail"></span><span class="pill retailUSD"></span></div></div>
<div class="price-block wholesale-block"><div class="price-title">–û–ø—Ç</div><div class="price-row"><span class="pill opt"></span><span class="pill optUSD"></span></div></div>
</div>
</div>
<div class="footer">
<div class="spacer"></div>
<button class="btn primary add">–£ –∫–æ—à–∏–∫</button>
</div>
</article></template>

<div aria-hidden="true" id="prodModalOverlay">
  <div aria-labelledby="prodModalTitle" aria-modal="true" class="panel" role="dialog">
    <div class="ph">
      <strong id="prodModalTitle">–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É</strong>
      <div class="spacer" style="flex:1"></div>
      <button class="btn" id="prodModalClose" type="button">‚úï</button>
    </div>
    <div class="pb" id="prodModalBody"></div>
    <div class="actions">
      <button class="btn" id="prodModalOk" type="button">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>
</div>

<button id="global-flip-back" type="button">‚Üê –ù–∞–∑–∞–¥</button>

<!-- –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script src="products.js"></script>

<script>
// –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ç–∞–ª–æ–≥—É: —Å—Ç–≤–æ—Ä—é—î–º–æ CATALOG –±–µ–∑ –∑–º—ñ–Ω–∏ const products
(function(){
  let base = [];
  try{
    if (Array.isArray(window.products)) base = window.products;
    else if (typeof products !== 'undefined' && Array.isArray(products)) base = products;
  }catch(e){
    base = [];
  }

  window.CATALOG = base.map(p => ({
    ...p, // ‚Üê –ø—Ä–∞–≤–∏–ª—å–Ω–æ: —Ä–æ–∑–≥–æ—Ä—Ç–∞—î–º–æ –≤–∏—Ö—ñ–¥–Ω–∏–π –æ–±‚Äô—î–∫—Ç
    barcode: String(p?.barcode ?? '').trim(),
    name:    String(p?.name ?? '').trim(),
    type:    p?.type  ? String(p.type).trim()  : '',
    color:   p?.color ? String(p.color).trim() : '',
    imgs:    Array.isArray(p?.imgs) ? p.imgs.filter(Boolean) : [],
    // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ —Ç–µ–∫—Å—Ç –æ–ø–∏—Å—É
    description: (typeof p?.description === 'string' && p.description.trim())
                 ? p.description
                 : (typeof p?.desc === 'string' ? p.desc : '')
  }));
})();
</script>

<script>
    /* =================== CONFIG =================== */
    const CONFIG = {
      DEFAULT_IMG: 'https://placehold.co/800x600/png?text=–§–æ—Ç–æ',
      RATE: 41.00,
      PROMOCODES: { 'WELCOME5': 0.05, 'VIP10': 0.10 },
      APPS_SCRIPT_WEBHOOK: 'https://script.google.com/macros/s/AKfycbwLb1Hmyb5HZPfutet7aqGNnbxnsHdLnncm24NfhYxYuEzVZ0Xv77rpB9bH7WGan9w/exec', // <-- –≤—Å—Ç–∞–≤—Ç–µ URL –≤–µ–±—Ö—É–∫–∞
      TELEGRAM: { ENABLED:true, BOT_TOKEN:'8279996038:AAGt-f0lfhlJAyIARqXfsZm7OIQzrBXJ_A4', CHAT_ID:'-4861598462' } // –æ–ø—Ü—ñ–π–Ω–æ
    };

    let state = {
      rate: CONFIG.RATE,
      items: [], // –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω—ñ
      cart: JSON.parse(localStorage.getItem('cart')||'[]'),
      promo: null
    };

    const fmtUAH = v => (Math.round(v).toLocaleString('uk-UA')+ ' –≥—Ä–Ω');
    const fmtUSD = v => ('$' + (Math.round(v*100)/100).toFixed(2));

    const WHOLESALE_THRESHOLD_USD = 500;
    function wholesaleActive(){
      const retailUSD = state.cart.reduce((s,i)=> s + i.qty * (i.retailUSD ?? i.priceUSD ?? 0), 0);
      return retailUSD > WHOLESALE_THRESHOLD_USD;
    }
    function priceFor(item){
      if(wholesaleActive()){
        return {
          UAH: item.wholesaleUAH ?? item.priceUAH ?? item.retailUAH ?? 0,
          USD: item.wholesaleUSD ?? item.priceUSD ?? item.retailUSD ?? 0,
          mode: 'wholesale'
        };
      }
      return {
        UAH: item.retailUAH ?? item.priceUAH ?? 0,
        USD: item.retailUSD ?? item.priceUSD ?? 0,
        mode: 'retail'
      };
    }

    const round2 = v => Math.round(v*100)/100;
    const el = sel => document.querySelector(sel);


    const grid = el('#grid');
    const tpl = el('#cardTpl');

    function renderGrid(list){
      grid.innerHTML = '';
      list.forEach(p=>{
        const node = tpl.content.cloneNode(true);
        const card = node.querySelector('.card');
        card.querySelector('.name').textContent = p.name;
        card.querySelector('.barcode').textContent = p.barcode || '';
        card.querySelector('.type').textContent = p.type || '';
        card.querySelector('.color').textContent = p.color || '';
        card.querySelector('.retail').textContent = fmtUAH(p.retailUAH);
        card.querySelector('.retailUSD').textContent = fmtUSD(p.retailUSD);
        card.querySelector('.opt').textContent = fmtUAH(p.wholesaleUAH);
        card.querySelector('.optUSD').textContent = fmtUSD(p.wholesaleUSD);

        const slides = card.querySelector('.slides');
        const imgs = (p.imgs||[]).flatMap(s=>s.split(';')).map(s=>s.trim()).filter(Boolean);
        (imgs.length?imgs:[CONFIG.DEFAULT_IMG]).forEach(src=>{
          const s = document.createElement('div'); s.className = 'slide';
          const im = document.createElement('img'); im.src = src; im.alt = p.name;
          s.appendChild(im); slides.appendChild(s);
        });

        // –î–æ–¥–∞—Ç–∏ —É –∫–æ—à–∏–∫
        card.querySelector('.add').addEventListener('click', ()=>{ addToCart(p); if(window.__cartAnim) __cartAnim.bumpCart(); });
grid.appendChild(node);
      });
    }


    const typeSel = el('#typeSel');
    const colorSel = el('#colorSel');
    const sortSel = el('#sort');
    typeSel.addEventListener('change', applyFilters);
    colorSel.addEventListener('change', applyFilters);
    sortSel.addEventListener('change', applyFilters);

    function applyFilters(){
      let arr = [...CATALOG];
      const t = typeSel.value; const c = colorSel.value;
      if(t) arr = arr.filter(p=> (p.type||'')===t);
      if(c) arr = arr.filter(p=> (p.color||'')===c);
      const [k,dir] = sortSel.value.split('-');
      arr.sort((a,b)=> (a[k] > b[k] ? 1 : -1) * (dir==='asc'?1:-1));
      state.items = arr;
      renderGrid(arr);
      el('#status').textContent = `–ó–Ω–∞–π–¥–µ–Ω–æ ${arr.length} —Ç–æ–≤–∞—Ä—ñ–≤`;
    }

    function initFilters(){
      const types = [...new Set(CATALOG.map(p=>p.type).filter(Boolean))];
      typeSel.innerHTML = '<option value="">–í—Å—ñ</option>' + types.map(v=>`<option>${v}</option>`).join('');
      const colors = [...new Set(CATALOG.map(p=>p.color).filter(Boolean))];
      colorSel.innerHTML = '<option value="">–í—Å—ñ</option>' + colors.map(v=>`<option>${v}</option>`).join('');
    }


    const rateInput = el('#rateInput'); const rateInfo = el('#rateInfo');
    rateInput.value = state.rate;
    el('#btnUpdateRate').addEventListener('click', async()=>{
      try{
        const r = await fetch('https://bank.gov.ua/NBUStatService/v1/statdirectory/dollar_info?json');
        const j = await r.json();
        const v = Number(j?.[0]?.rate)||state.rate; state.rate = v; rateInput.value = v; rateInfo.textContent = `–ü–æ—Ç–æ—á–Ω–∏–π –∫—É—Ä—Å: ${v}`;
      }catch(e){ rateInfo.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ ‚Äî –≤–≤–µ–¥—ñ—Ç—å –≤—Ä—É—á–Ω—É'; }
    });
    rateInput.addEventListener('input',()=>{ const v=Number(rateInput.value.replace(',','.')); if(v>0){ state.rate=v; recalcByRate(); }});

    function recalcByRate(){
      CATALOG.forEach(p=>{
        p.retailUAH = Math.round(p.retailUSD * state.rate * 100)/100;
        p.wholesaleUAH = Math.round(p.wholesaleUSD * state.rate * 100)/100;
      });
      applyFilters();
      renderCart();
    }


    const cartBtn = el('#cartBtn'); const cart = el('#cart');
    const cartCount = el('#cartCount'); const cartList = el('#cartList');

    function saveCart(){ localStorage.setItem('cart', JSON.stringify(state.cart)); }
    function cartTotals(){
      const qty = state.cart.reduce((s,i)=> s+i.qty, 0);
      const sums = state.cart.reduce((acc,i)=> {
        const pf = priceFor(i);
        acc.sumUAH += i.qty * pf.UAH;
        acc.sumUSD += i.qty * pf.USD;
        return acc;
      }, {sumUAH:0, sumUSD:0});
      return {qty, ...sums};
    }
    function refreshCartBadge(){ cartCount.textContent = cartTotals().qty; }

function addToCart(p){
  const barcode = String(p.barcode || '').trim();
  const found = state.cart.find(i => i.barcode === barcode);
  const line = {
    lineId: crypto.randomUUID(),
    name: p.name,
    barcode,
    type: p.type || '',     // ‚Üê –≤–∞–∂–ª–∏–≤–æ
    color: p.color || '',   // ‚Üê –≤–∞–∂–ª–∏–≤–æ
    img: (p.imgs?.[0] || CONFIG.DEFAULT_IMG),
    retailUAH: p.retailUAH, wholesaleUAH: p.wholesaleUAH,
    priceUAH: p.retailUAH,
    retailUSD: p.retailUSD, wholesaleUSD: p.wholesaleUSD,
    priceUSD: p.retailUSD,
    qty: 1
  };
  if (found) found.qty += 1; else state.cart.push(line);
  saveCart(); refreshCartBadge(); renderCart(); }



    function renderCart(){
      cartList.innerHTML = '';
      state.cart.forEach(item=>{
        const row = document.createElement('div'); row.className='cart-item';
        row.innerHTML = `
          <img src="${item.img}" alt="${item.name}">
          <div>
            <div class="title" style="font-weight:700;font-size:14px;line-height:1.2">${item.name}</div>
            <div class="hint">${item.barcode||''}</div>
            <div class="qty">
              <button class="btn" data-dec>-</button>
              <input value="${item.qty}" inputmode="numeric" />
              <button class="btn" data-inc>+</button>
            </div>
          </div>
          <div><b>${fmtUAH(priceFor(item).UAH * item.qty)}</b><br>
              <small class="hint">${fmtUSD(priceFor(item).USD * item.qty)}</small>
              <br><button class="btn" data-del>–í–∏–¥–∞–ª–∏—Ç–∏</button></div>
        `;
        row.querySelector('[data-inc]').onclick = ()=>{ item.qty++; saveCart(); renderCart(); refreshCartBadge(); };
        row.querySelector('[data-dec]').onclick = ()=>{ item.qty=Math.max(1,item.qty-1); saveCart(); renderCart(); refreshCartBadge(); };
        row.querySelector('input').onchange = e=>{ const v=parseInt(e.target.value||'1',10); item.qty=Math.max(1,isNaN(v)?1:v); saveCart(); renderCart(); refreshCartBadge(); };
        row.querySelector('[data-del]').onclick = ()=>{ state.cart = state.cart.filter(x=>x.lineId!==item.lineId); saveCart(); renderCart(); refreshCartBadge(); };
        cartList.appendChild(row);
      });
            const {sumUAH,sumUSD,qty} = cartTotals();
      el('#cartTotal').textContent = `${fmtUAH(sumUAH)} ‚Ä¢ ${fmtUSD(sumUSD)}`;
      el('#ckItems').textContent = `${qty} —Ç–æ–≤–∞—Ä—ñ–≤`;
      el('#ckTotal').textContent = fmtUAH(applyPromo(sumUAH));

      // –û–¥–∏–Ω —Ä–∞–∑ —Ä–∞—Ö—É—î–º–æ, —á–∏ –∞–∫—Ç–∏–≤–Ω–∏–π –æ–ø—Ç
      const isWholesale = wholesaleActive();

      // –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –ø–æ–∑–Ω–∞—á–∫—É "–û–ø—Ç –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ"
      const flagId = 'wholesaleFlag';
      let flag = document.getElementById(flagId);
      if(!flag){
        const foot = document.querySelector('#cart .foot');
        flag = document.createElement('div');
        flag.id = flagId;
        flag.className = 'wholesale-flag';
        foot.insertBefore(flag, foot.firstChild);
      }
      flag.textContent = isWholesale ? '–û–ø—Ç –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ: —Ü—ñ–Ω–∏ –∑–∞ –æ–ø—Ç–æ–º' : '';
      flag.style.display = isWholesale ? 'flex' : 'none';

      // –ê–Ω–∞–ª–æ–≥—ñ—á–Ω–∞ –ø—ñ–¥–∫–∞–∑–∫–∞ —É —á–µ–∫–∞—É—Ç—ñ
      const nId = 'ckWholesaleNote';
      let note = document.getElementById(nId);
      if(!note){
        note = document.createElement('div');
        note.id = nId;
        note.className = 'wholesale-note';
        const step3 = document.querySelector('#checkout .step:nth-of-type(3)');
        step3 && step3.appendChild(note);
      }
      note.textContent = isWholesale ? '–ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –æ–ø—Ç–æ–≤—ñ —Ü—ñ–Ω–∏ (–ø–æ—Ä—ñ–≥ $500 –ø–µ—Ä–µ–≤–∏—â–µ–Ω–æ)' : '';
      note.style.display = isWholesale ? 'block' : 'none';
    }

    el('#cartClear').onclick = ()=>{ state.cart=[]; saveCart(); renderCart(); refreshCartBadge(); };
    cartBtn.onclick = openCart; el('#closeCart').onclick = closeCart;
    function openCart(){ cart.classList.add('open'); document.body.classList.add('cart-open'); }
    function closeCart(){ cart.classList.remove('open'); document.body.classList.remove('cart-open'); }


    const promoBadge = el('#promoState'); const promoInput = el('#promo');
    promoInput.addEventListener('change',()=>{ state.promo = promoInput.value.trim().toUpperCase()||null; renderCart(); updatePromoBadge(); });
    function updatePromoBadge(){
      if(state.promo && CONFIG.PROMOCODES[state.promo]){ promoBadge.textContent = `${state.promo}: -${CONFIG.PROMOCODES[state.promo]*100}%`; promoBadge.classList.add('ok'); promoBadge.classList.remove('bad'); }
      else if(state.promo){ promoBadge.textContent = `${state.promo}: –Ω–µ–¥—ñ–π—Å–Ω–∏–π`; promoBadge.classList.add('bad'); promoBadge.classList.remove('ok'); }
      else{ promoBadge.textContent = '–Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ'; promoBadge.classList.remove('ok','bad'); }
    }
    function applyPromo(sum){ const p = state.promo && CONFIG.PROMOCODES[state.promo]; return p ? Math.round(sum*(1-p)) : sum; }


    const checkout = el('#checkout');
    el('#checkoutBtn').onclick = ()=>{ closeCart && closeCart(); openCheckout && openCheckout(); };
    el('#closeCheckout').onclick = ()=> closeCheckout();
    el('#backToCart').onclick = ()=>{ closeCheckout(); openCart(); };

    function openCheckout(){
  checkout.classList.add('open');
  checkout.setAttribute('aria-hidden','false');
  const body = checkout.querySelector('.ck-body');
  if(body){ body.scrollTop = 0; }
}
    function closeCheckout(){ checkout.classList.remove('open'); checkout.setAttribute('aria-hidden','true'); }
    function openCheckoutWithItem(p){ addToCart(p); openCheckout(); }

// –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
el('#placeOrderBtn').onclick = async()=>{
  const {sumUAH,sumUSD,qty} = cartTotals();
  if(qty===0){
    alert('–î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏ —É –∫–æ—à–∏–∫');
    return;
  }

  const order = {
    id: 'B' + Date.now(),
    createdAt: new Date().toISOString(),
    customer: {
      name: el('#fName').value.trim(),
      phone: el('#fPhone').value.trim(),
      email: el('#fEmail').value.trim(),
      note:  el('#fNote').value.trim()
    },
    shipping: {
      method: el('#fShip').value,
      city:   el('#fCity').value.trim(),
      address:el('#fAddress').value.trim()
    },
    payment: { method: el('#fPay').value },
    promo: state.promo || '',
    currency: { rate: state.rate },
    items: state.cart.map(i => ({
      name: i.name,
      type: i.type,
      color: i.color,
      barcode: i.barcode,
      priceUAH: i.priceUAH,
      priceUSD: i.priceUSD,
      qty: i.qty
    })),
    totals: { qty, sumUAH: applyPromo(sumUAH), sumUSD }
  };



      // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
      if(!order.customer.name || !order.customer.phone || !order.shipping.city || !order.shipping.address){
        el('#submitState').textContent = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ –ø–æ–ª—è';
        return;
      }

      el('#submitState').textContent = '–ù–∞–¥—Å–∏–ª–∞—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è‚Ä¶';

      try{
        // 1) Google Sheet —á–µ—Ä–µ–∑ Apps Script
        if(CONFIG.APPS_SCRIPT_WEBHOOK.startsWith('https://')){
      await fetch(CONFIG.APPS_SCRIPT_WEBHOOK, {
        method: 'POST',
        mode: 'no-cors',    // –≤–∞–∂–ª–∏–≤–æ
        body: JSON.stringify(order)
      });
        }



// --- –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ Telegram ---
if (CONFIG.TELEGRAM.ENABLED && CONFIG.TELEGRAM.BOT_TOKEN && CONFIG.TELEGRAM.CHAT_ID) {
  // –õ—ñ—á–∏–ª—å–Ω–∏–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å
  let orderNum = parseInt(localStorage.getItem('orderCounter') || '0', 10) + 1;
  localStorage.setItem('orderCounter', orderNum);

  // ID —Ç–∏–ø—É B01, B02...
  const orderId = 'B' + String(orderNum).padStart(2, '0');
  order.id = orderId;

  const sumUAH = Math.round(order.totals.sumUAH);
  const sumUSD = order.totals.sumUSD.toFixed(2);

  // –§–æ—Ä–º—É—î–º–æ –¥–∞—Ç—É –π —á–∞—Å
  const now = new Date();
  const dateStr = now.toLocaleDateString('uk-UA');
  const timeStr = now.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });

  // –§–æ—Ä–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤
const itemsList = order.items
  .map((it, i) => {
    const typePart  = it.type  ? ` | ${it.type}` : '';
    const colorPart = it.color ? ` (${it.color})` : '';
    const idPart    = it.barcode ? ` | ID: ${it.barcode}` : '';
    return `${i + 1}) ${it.name}${typePart}${colorPart}${idPart} √ó${it.qty}`;
  })
  .join('\n');


    // –§–æ—Ä–º—É—î–º–æ —Å–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏
    let paymentMethod = 'üíµ –û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ';

    if (order.payment?.method === 'prepay') {
      paymentMethod = 'üí≥ –ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 200 –≥—Ä–Ω';
    } else if (order.payment?.method === 'full') {
      paymentMethod = 'üí≥ –ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞';
    }


  // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è Telegram
  const text = [
    `üõçÔ∏è –ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ${orderId}`,
    `üïí ${dateStr}, ${timeStr}`,
    ``,
    `–Ü–º‚Äô—è: ${order.customer.name}`,
    `–¢–µ–ª: ${order.customer.phone}`,
    `–ú—ñ—Å—Ç–æ: ${order.shipping.city}`,
    `–ê–¥—Ä–µ—Å–∞: ${order.shipping.address}`,
    ``,
    `–¢–æ–≤–∞—Ä—ñ–≤: ${order.totals.qty}`,
    `–°—É–º–∞: ${sumUAH} –≥—Ä–Ω ($${sumUSD})`,
    `${paymentMethod}`,
    ``,
    `üì¶ –ü–æ–∑–∏—Ü—ñ—ó:`,
    itemsList
  ].join('\n');

  try {
    const response = await fetch(`https://api.telegram.org/bot${CONFIG.TELEGRAM.BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: CONFIG.TELEGRAM.CHAT_ID,
        text
      })
    });

    const result = await response.json();
    if (!result.ok) console.error('–ü–æ–º–∏–ª–∫–∞ Telegram:', result);
  } catch (err) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ –¥–æ Telegram:', err);
  }
}

        // 3) –Ø–∫—â–æ –æ–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–∫–æ—é ‚Äî —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ –ø–ª–∞—Ç—ñ–∂–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É (–ø—ñ–¥–∫–ª—é—á—ñ—Ç—å –±–µ–∫–µ–Ω–¥)
        if(order.payment.method==='card'){
          alert('–û–ø–ª–∞—Ç–∞ –æ–Ω–ª–∞–π–Ω: –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å –µ–Ω–¥–ø–æ—ñ–Ω—Ç –ø–ª–∞—Ç–µ–∂—É (LiqPay/Monobank/Stripe). –ü–æ–∫–∏ —â–æ ‚Äî –ø—ñ—Å–ª—è–ø–ª–∞—Ç–∞.');
        }

        el('#submitState').textContent = '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ. –î—è–∫—É—î–º–æ!';
        if(window.__openRequisitesMessage) window.__openRequisitesMessage();
        state.cart = []; saveCart(); renderCart(); refreshCartBadge();
        setTimeout(()=>{ closeCheckout(); closeCart(); }, 600);
      }catch(e){
        console.error(e);
        el('#submitState').textContent = '–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å –Ω–∞–º.';
      }
    };


    el('#exportXLSX').onclick = ()=>{
      const rows = state.items.map(p=> ({
        –ù–∞–∑–≤–∞:p.name, –®—Ç—Ä–∏—Ö–∫–æ–¥:p.barcode, –¢–∏–ø:p.type, –ö–æ–ª—ñ—Ä:p.color,
        –†–æ–∑–¥—Ä—ñ–±_UAH: p.retailUAH, –†–æ–∑–¥—Ä—ñ–±_USD:p.retailUSD,
        –û–ø—Ç_UAH:p.wholesaleUAH, –û–ø—Ç_USD:p.wholesaleUSD,
        –ü–æ—Å–∏–ª–∞–Ω–Ω—è:p.link
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '–ö–∞—Ç–∞–ª–æ–≥');
      XLSX.writeFile(wb, 'catalog.xlsx');
    };

    el('#resetBtn').onclick = ()=>{ typeSel.value=''; colorSel.value=''; sortSel.value='name-asc'; applyFilters(); };

function boot(){
  if (CATALOG.length===0) {
    document.querySelector('#status').innerHTML = '‚ö†Ô∏è –î–æ–¥–∞–π—Ç–µ –º–∞—Å–∏–≤ <code>products</code> —É CONFIG-–±–ª–æ—Ü—ñ!';
  }
  // –≤–∞–∂–ª–∏–≤–æ: –æ–¥—Ä–∞–∑—É –ø–æ –∫—É—Ä—Å—É –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ UAH-—Ü—ñ–Ω–∏
  recalcByRate();
  initFilters();
  applyFilters();
  refreshCartBadge();
  renderCart();
}

    boot();
  </script>

<script>
(function(){
  function initSlider(slider){
    if(slider.__inited) return;
    const track = slider.querySelector('.slides');
    if(!track) return;
    slider.__inited = true;

    // Build arrows & dots containers
    const nav = document.createElement('div');
    nav.className = 'nav';
    const prev = document.createElement('button');
    prev.className = 'arrow'; prev.type='button'; prev.setAttribute('aria-label','–ü–æ–ø–µ—Ä–µ–¥–Ω—î'); prev.textContent = '‚Äπ';
    const next = document.createElement('button');
    next.className = 'arrow'; next.type='button'; next.setAttribute('aria-label','–ù–∞—Å—Ç—É–ø–Ω–µ'); next.textContent = '‚Ä∫';
    nav.appendChild(prev); nav.appendChild(next);
    const dots = document.createElement('div'); dots.className = 'dots';
    slider.appendChild(nav); slider.appendChild(dots);

    function pageWidth(){ return slider.clientWidth; }
    function slideCount(){ return track.children.length; }

    function goTo(index){
      index = Math.max(0, Math.min(index, slideCount()-1));
      const x = index * pageWidth();
      track.scrollTo({left: x, behavior: 'smooth'});
      updateDotsByIndex(index);
    }

    function activeIndex(){
      const idx = Math.round(track.scrollLeft / pageWidth());
      return Math.max(0, Math.min(idx, slideCount()-1));
    }

    function updateDots(){
      dots.innerHTML = '';
      const n = slideCount();
      for(let i=0;i<n;i++){
        const b = document.createElement('button');
        b.type='button';
        b.setAttribute('aria-label', `–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Å–ª–∞–π–¥—É ${i+1}`);
        if(i===activeIndex()) b.setAttribute('aria-current','true');
        b.addEventListener('click', ()=>goTo(i));
        dots.appendChild(b);
      }
    }
    function updateDotsByIndex(idx){
      [...dots.children].forEach((b,i)=>{
        if(i===idx) b.setAttribute('aria-current','true'); else b.removeAttribute('aria-current');
      });
    }

    prev.addEventListener('click', ()=>goTo(activeIndex()-1));
    next.addEventListener('click', ()=>goTo(activeIndex()+1));

    // Keep dots in sync on scroll/resize/content changes
    track.addEventListener('scroll', ()=> updateDotsByIndex(activeIndex()), {passive:true});
    window.addEventListener('resize', ()=> updateDotsByIndex(activeIndex()));

    const mo = new MutationObserver(()=>{ updateDots(); updateDotsByIndex(activeIndex()); });
    mo.observe(track, {childList:true, subtree:false});

    // Initialize now
    updateDots();
    updateDotsByIndex(activeIndex());
  }

  function initAll(){
    document.querySelectorAll('.slider').forEach(initSlider);
  }

  document.addEventListener('DOMContentLoaded', initAll);
  // In case cards are added dynamically later:
  const ro = new MutationObserver(()=> initAll());
  ro.observe(document.documentElement, {childList:true, subtree:true});
})();

</script>

<script>
(function(){
  function bumpCart(){
    const btn = document.getElementById('cartBtn');
    const cnt = document.getElementById('cartCount');
    if(btn){
      btn.classList.remove('bump'); btn.classList.remove('flash'); void btn.offsetWidth;
      btn.classList.add('bump'); btn.classList.add('flash');
      btn.addEventListener('animationend', ()=> btn.classList.remove('flash'), {once:true});
    }
    if(cnt){ cnt.classList.remove('bump'); void cnt.offsetWidth; cnt.classList.add('bump'); }
  }
  window.__cartAnim = { bumpCart };
})();
</script>

<script>
(function(){
  const btn = document.getElementById('cartBtn');
  if(btn && !btn.querySelector('.icon')){
    const span = document.createElement('span');
    span.className = 'icon';
    span.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 4h-2a1 1 0 0 0 0 2h1.28l1.7 8.51A2 2 0 0 0 9.93 16h7.4a2 2 0 0 0 1.97-1.6l1.3-6.5A1 1 0 0 0 19.6 6H8.22l-.3-1.45A2 2 0 0 0 7 4Zm3 16a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm9 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"/></svg>';
    btn.prepend(span);
  }
})();
</script>

<script>
(function(){
  // helper shortcuts
  const $ = (sel)=>document.querySelector(sel);
  const el = (sel)=>document.querySelector(sel);

  // Ensure payment options are correct even if rendered later
  function ensurePayOptions(){
    const sel = document.getElementById('fPay');
    if(!sel) return;
    const html = '<option value="prepay">–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (200 –≥—Ä–Ω)</option><option value="full">–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞</option>';
    if(sel.innerHTML.trim() !== html) sel.innerHTML = html;
  }

  // Prepay availability and summary
function updatePaymentAvailability(){
  const sel = document.getElementById('fPay');
  if(!sel) return;
  const prepay = sel.querySelector('option[value="prepay"]');
  if(!prepay) return;

  // –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ "–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 200 –≥—Ä–Ω", —è–∫—â–æ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –æ–ø—Ç–æ–≤—ñ —Ü—ñ–Ω–∏
  const isWholesale = (typeof wholesaleActive === 'function') ? wholesaleActive() : false;
  prepay.disabled = !!isWholesale;
  if(isWholesale && sel.value === 'prepay'){
    sel.value = 'full';
  }
}

  function updatePaySummary(){
    const sel = document.getElementById('fPay');
    const totalEl = document.getElementById('ckTotal');
    if(!sel || !totalEl) return;
    try{
      if(sel.value === 'prepay'){
        totalEl.textContent = '200 –≥—Ä–Ω (–ø–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞)';
      }else if(typeof cartTotals==='function' && typeof applyPromo==='function' && typeof fmtUAH==='function'){
        const { sumUAH } = cartTotals();
        totalEl.textContent = fmtUAH(applyPromo(sumUAH));
      }
    }catch(e){ /* ignore */ }
  }

  // Required fields validation + mask
  const reqIds = ['fName','fPhone','fCity','fAddress'];
  function mark(el,bad){
    if(!el) return;
    if(bad){ el.classList.add('err'); el.closest('label') && el.closest('label').classList.add('err'); }
    else { el.classList.remove('err'); el.closest('label') && el.closest('label').classList.remove('err'); }
  }
  function validateRequired(){
    let ok = true;
    const submitState = document.getElementById('submitState');
    reqIds.forEach(id=>{
      const node = document.getElementById(id);
      if(!node) return;
      let valid = !!node.value && node.value.trim().length >= 2;
      if(id==='fPhone'){
        const v = (node.value||'').trim();
        valid = /^\+380\d{9}$/.test(v);
      }
      mark(node, !valid);
      ok = ok && valid;
    });
    if(!ok && submitState){
      submitState.textContent = '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ –ø–æ–ª—è. –¢–µ–ª–µ—Ñ–æ–Ω —É —Ñ–æ—Ä–º–∞—Ç—ñ +380XXXXXXXXX';
    }else if(submitState){
      submitState.textContent = '';
    }
    return ok;
  }
  // live clear highlight
  reqIds.forEach(id=>{
    const node = document.getElementById(id);
    if(node){
      ['input','change','blur'].forEach(ev=>{
        node.addEventListener(ev, ()=>{
          if(node.classList.contains('err')){
            let valid = !!node.value && node.value.trim().length >= 2;
            if(id==='fPhone'){
              const v = (node.value||'').trim();
              valid = /^\+380\d{9}$/.test(v);
            }
            mark(node, !valid);
          }
        });
      });
    }
  });
  // phone mask
  const phone = document.getElementById('fPhone');
  if(phone){
    const formatUA = ()=>{
      let v = phone.value.replace(/[^\d+]/g,'');
      if(!v.startsWith('+')) v = '+' + v.replace(/^\+/, '');
      if(v==='+'||v==='+3'||v==='+38') v = '+380';
      v = v.slice(0,13);
      phone.value = v;
    };
    phone.addEventListener('input', formatUA);
    if(!phone.value) phone.value = '+380';
  }

  // Wrap "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è" handler safely
  function wrapPlaceOrder(){
    const btn = document.getElementById('placeOrderBtn');
    if(!btn) return;
    const orig = btn.onclick;
    btn.onclick = async (e)=>{
      if(!validateRequired()){
        e && e.preventDefault && e.preventDefault();
        return;
      }
      if(typeof orig === 'function'){
        const res = await orig.call(btn, e);
        return res;
      }
    };
  }

  // Show requisites modal when success message appears
  function setupSuccessObserver(){
    const target = document.getElementById('submitState');
    if(!target) return;
    const modal = document.getElementById('paymentModal');
    const body = document.getElementById('payBody') || (modal ? modal.querySelector('.pb') : null);
    const closeBtn = document.getElementById('payClose');
    const okBtn = document.getElementById('payOk');
    const openModal = ()=>{
      if(body){
        body.innerHTML = [
          '<div><strong>–†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –æ–ø–ª–∞—Ç–∏:</strong></div>',
          '–§–û–ü –ö—É—Ä—Ç –ú–∞—Ö–º—É—Ç –§–∏—Ä–∞—Ç',
          'IBAN: <code>UA713220010000026006350089361</code>',
          '–Ü–ü–ù/–Ñ–î–†–ü–û–£: <code>2938328518</code>',
          '–ú–§–û: <code>322001</code>',
          '–Ñ–î–†–ü–û–£ –ë–∞–Ω–∫—É: <code>21133352</code>',
          '<br>',
          '‚ùóÔ∏è–í –¥–æ–¥–∞—Ç–∫–∞—Ö –±–∞–Ω–∫—ñ–≤ –∞–±–æ —Ç–µ—Ä–º—ñ–Ω–∞–ª–∞—Ö –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–±—Ä–∞—Ç–∏ –ø–ª–∞—Ç—ñ–∂ –∑–∞ IBAN –∞–±–æ –∑–∞ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∞–º–∏.',
          '‚ùóÔ∏è–í –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—ñ –ø–ª–∞—Ç–µ–∂—É –≤–∫–∞–∂—ñ—Ç—å –≤–∞—à–µ –ø—Ä—ñ–∑–≤–∏—â–µ —Ç–∞ —ñ–º‚Äô—è.',
          '<br>',
          '–ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –∫–≤–∏—Ç–∞–Ω—Ü—ñ—é –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤ Instagram ‚ù§Ô∏è'
        ].map(s=>`<div class="row">${s}</div>`).join('');
      }
      if(modal){
        modal.style.display='flex';
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
      }
      if(closeBtn) closeBtn.onclick = ()=>{ modal.style.display='none'; modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); };
      if(okBtn) okBtn.onclick = ()=>{ modal.style.display='none'; modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); };
    };
    const obs = new MutationObserver(()=>{
      const txt = (target.textContent || '').trim();
      if(txt.includes('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ')){
        openModal();
      }
    });
    obs.observe(target, {childList:true, subtree:true, characterData:true});
  }

  // Bind change for payment select
  function bindPayChange(){
    const sel = document.getElementById('fPay');
    if(!sel) return;
    sel.addEventListener('change', ()=>{ updatePaymentAvailability(); updatePaySummary(); });
  }

  // Initialize after a tiny delay to ensure original handlers are set
  function init(){
    ensurePayOptions();
    updatePaymentAvailability();
    updatePaySummary();
    wrapPlaceOrder();
    setupSuccessObserver();
    bindPayChange();
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ()=>setTimeout(init, 50));
  else setTimeout(init, 50);

  // Re-run availability/summary whenever cart re-renders (if app exposes renderCart, monkey-patch it)
  try{
    if(typeof renderCart === 'function'){
      const _renderCart = renderCart;
      window.renderCart = function(){ const res = _renderCart.apply(this, arguments); try{ updatePaymentAvailability(); updatePaySummary(); }catch(e){} return res; };
    }
  }catch(e){}
})();
</script>

<script id="flip-card-script">
(function(){
  function productFromCard(card){
    try{
      var name = card.querySelector('.name')?.textContent?.trim() || '';
      var barcode = card.querySelector('.barcode')?.textContent?.trim() || '';
      var p = Array.isArray(window.CATALOG) ? window.CATALOG.find(function(x){
        return String(x.name||'').trim()===name && String(x.barcode||'').trim()===barcode;
      }) : null;
      return p || null;
    }catch(e){ return null; }
  }

  function ensureFlipStructure(card){
    if(!card || card.querySelector('.flip-inner')) return;
    var children = Array.from(card.childNodes);
    var inner = document.createElement('div');
    inner.className = 'flip-inner';
    var front = document.createElement('div'); front.className = 'front';
    var back  = document.createElement('div'); back.className  = 'back';

    // Move all existing content into front
    children.forEach(function(n){ front.appendChild(n); });
    // Build back skeleton
    var head = document.createElement('div'); head.className='desc-head';
    var title= document.createElement('div'); title.className='title'; head.appendChild(title);
    back.appendChild(head);

    var meta = document.createElement('div'); meta.className='meta';
    var t = document.createElement('span'); t.className='type badge'; meta.appendChild(t);
    var c = document.createElement('span'); c.className='color badge'; meta.appendChild(c);
    back.appendChild(meta);

    var desc = document.createElement('div'); desc.className='desc-scroll'; desc.setAttribute('data-desc','true'); back.appendChild(desc);

    var actions = document.createElement('div'); actions.className='desc-actions';
    var backBtn = document.createElement('button'); backBtn.type='button'; backBtn.className='btn back'; backBtn.textContent='‚Üê –ù–∞–∑–∞–¥';
    actions.appendChild(backBtn); back.appendChild(actions);

    inner.appendChild(front); inner.appendChild(back);
    card.appendChild(inner);

    backBtn.addEventListener('click', function(ev){ ev.stopPropagation(); card.classList.remove('flipped'); });
  }

  function fillBack(card, p){
    if(!card || !p) return;
    var title = card.querySelector('.back .desc-head .title');
    if(title) title.textContent = p.name || '–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É';
    var typeB = card.querySelector('.back .meta .type');
    var colorB= card.querySelector('.back .meta .color');
    if(typeB) typeB.textContent = p.type || '';
    if(colorB) colorB.textContent = p.color || '';
    var descNode = card.querySelector('.back [data-desc="true"]');
    var desc = (p.description || p.desc || '').trim();
    if(!desc){
      var parts = [];
      if(p.barcode) parts.push('ID: '+p.barcode);
      if(p.type) parts.push('–¢–∏–ø: '+p.type);
      if(p.color) parts.push('–ö–æ–ª—ñ—Ä: '+p.color);
      if(typeof fmtUAH==='function' && typeof fmtUSD==='function'){
        if(p.retailUAH) parts.push('–†–æ–∑–¥—Ä—ñ–±: ' + fmtUAH(p.retailUAH) + ' ‚Ä¢ ' + fmtUSD(p.retailUSD||0));
        if(p.wholesaleUAH) parts.push('–û–ø—Ç: ' + fmtUAH(p.wholesaleUAH) + ' ‚Ä¢ ' + fmtUSD(p.wholesaleUSD||0));
      }
      desc = parts.join('\n');
    }
    if(descNode){
      descNode.innerHTML = String(desc).replace(/</g,'&lt;').replace(/\n/g,'<br>');
    }
  }

<!--  function ensureDescButton(card){-->
<!--    var footer = card.querySelector('.footer');-->
<!--    var spacer = footer ? footer.querySelector('.spacer') : null;-->
<!--    if(!footer || !spacer) return;-->
<!--    var btn = footer.querySelector('.btn.ghost.view');-->
<!--    if(!btn){-->
<!--      btn = document.createElement('button');-->
<!--      btn.className = 'btn ghost view';-->
<!--      btn.type = 'button';-->
<!--      btn.textContent = '–û–ø–∏—Å';-->
<!--      footer.insertBefore(btn, spacer);-->
<!--    }-->
<!--    if(!btn.__flipWired){-->
<!--      btn.addEventListener('click', function(ev){-->
<!--        ev.stopPropagation();-->
<!--        ensureFlipStructure(card);-->
<!--        var p = productFromCard(card) || {};-->
<!--        fillBack(card, p);-->
<!--        // set min-height for smoothness equal to front height-->
<!--        var front = card.querySelector('.front');-->
<!--        if(front){-->
<!--// lock height to front via CSS var (&#45;&#45;flip-h)-->
<!--var front = card.querySelector('.front');-->
<!--var inner = card.querySelector('.flip-inner');-->
<!--if (front && inner) {-->
<!--  const h = Math.ceil(front.scrollHeight || front.getBoundingClientRect().height);-->
<!--  card.style.setProperty('&#45;&#45;flip-h', h > 0 ? h + 'px' : 'auto');-->
<!--}-->
<!--card.classList.add('flipped');-->

<!--        }-->
<!--        card.classList.add('flipped');-->
<!--      });-->
<!--      btn.__flipWired = true;-->
<!--    }-->
<!--  }-->

  function enhanceCard(card){
    ensureDescButton(card);
  }
  function enhanceAll(){
    document.querySelectorAll('#grid .card').forEach(enhanceCard);
  }

  // Patch renderGrid safely
  if(typeof renderGrid === 'function' && !window.__flipRenderPatchedSafe){
    var _render = renderGrid;
    window.renderGrid = function(list){
      var res = _render.call(this, list);
      try{ enhanceAll(); }catch(e){}
      return res;
    };
    window.__flipRenderPatchedSafe = true;
  }

  // Initial + observe
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      setTimeout(enhanceAll, 60);
      setTimeout(enhanceAll, 200);
    });
  }else{
    setTimeout(enhanceAll, 60);
    setTimeout(enhanceAll, 200);
  }
  var grid = document.getElementById('grid');
  if(grid){
    var mo = new MutationObserver(function(){ enhanceAll(); });
    mo.observe(grid, {childList:true, subtree:true});
  }
})();</script>

<script id="add-flip-back-btn-script">
(function(){
  function ensureBackButtons(root){
    try{
      var cards = (root || document).querySelectorAll('.card');
      cards.forEach(function(card){
        var back = card.querySelector('.back');
        if(!back) return; // nothing to do if there is no back side
        var existing = back.querySelector('.btn.back, .flip-back, [data-action="flip-back"]');
        if(!existing){
          var actions = back.querySelector('.desc-actions') || back;
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn back';
          btn.setAttribute('data-action','flip-back');
          btn.textContent = '‚Üê –ù–∞–∑–∞–¥';
          // Prefer to insert at start of .desc-actions, otherwise append to back
          if(actions.firstChild) actions.insertBefore(btn, actions.firstChild);
          else actions.appendChild(btn);
        }
      });
      // wire events
      (root || document).querySelectorAll('.card .back [data-action="flip-back"]').forEach(function(b){
        if(b.__wiredFlipBack) return;
        b.__wiredFlipBack = true;
        b.addEventListener('click', function(e){
          var card = e.target.closest('.card');
          if(card) card.classList.remove('flipped');
          e.stopPropagation();
        });
      });
    }catch(e){ /* silent */ }
  }

  // Run once on DOM ready
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ ensureBackButtons(); });
  }else{
    ensureBackButtons();
  }

  // If app exposes renderGrid, patch it to run our enhancer after rendering
  try{
    if(typeof renderGrid === 'function' && !window.__patchedRenderGridForBackBtn){
      window.__patchedRenderGridForBackBtn = true;
      var _renderGrid = renderGrid;
      window.renderGrid = function(){
        var res = _renderGrid.apply(this, arguments);
        try{ ensureBackButtons(document.getElementById('grid')); }catch(_){}
        return res;
      }
    }
  }catch(e){}

  // Observe grid for new cards dynamically
  try{
    var grid = document.getElementById('grid') || document.querySelector('.container, [data-grid="products"]');
    if(grid){
      var mo = new MutationObserver(function(){ ensureBackButtons(grid); });
      mo.observe(grid, { childList:true, subtree:true });
    }
  }catch(e){}
})();
</script>

<script>
      (function(){
        function addBackButtons(root) {
          if(!root || !root.querySelectorAll) return;
          root.querySelectorAll('.card').forEach(function(card){
            var back = card.querySelector('.back');
            if(!back) return;
            if(!back.querySelector('.flip-back-btn')) {
              var btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'flip-back-btn';
              btn.textContent = '\u2190 –ù–∞–∑–∞–¥';
              back.prepend(btn);
            }
          });
        }

        // Initial pass
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function(){ addBackButtons(document); });
        } else {
          addBackButtons(document);
        }

        // Watch for dynamically created cards/backs
        var mo = new MutationObserver(function(muts){
          muts.forEach(function(m){
            m.addedNodes && m.addedNodes.forEach(function(n){
              if(n && n.nodeType === 1) {
                // element
                addBackButtons(n);
              }
            });
          });
        });
        try { mo.observe(document.body, { childList: true, subtree: true }); } catch(e) { /* no-op */ }

        // Delegate click: flip back
        document.addEventListener('click', function(ev){
          var btn = ev.target && ev.target.closest ? ev.target.closest('.flip-back-btn') : null;
          if(btn) {
            ev.preventDefault();
            ev.stopPropagation();
            var card = btn.closest('.card');
            if(card) {
              card.classList.remove('flipped');
            }
          }
        }, true);
      })();
</script>

<script>
      (function(){
        var lastFlipped = null;
        function updateState() {
          var flipped = document.querySelectorAll('.card.flipped');
          document.documentElement.classList.toggle('has-flipped', flipped.length>0);
          // try pick the most recently flipped card if we don't have one
          if(!lastFlipped || !lastFlipped.isConnected || !lastFlipped.classList.contains('flipped')) {
            lastFlipped = flipped[flipped.length-1] || null;
          }
        }
        // Watch for class changes and DOM changes
        var mo = new MutationObserver(function(muts){
          var needs = false;
          muts.forEach(function(m){
            if(m.type === 'attributes' && m.attributeName === 'class' && m.target.matches && m.target.matches('.card')) needs = true;
            if(m.addedNodes && m.addedNodes.length) needs = true;
            if(m.removedNodes && m.removedNodes.length) needs = true;
          });
          if(needs) updateState();
        });
        try { mo.observe(document.body, { subtree:true, childList:true, attributes:true, attributeFilter:['class'] }); } catch(e){}
        // initial
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', updateState);
        } else {
          updateState();
        }
        // capture flips when clicking "–û–ø–∏—Å" or anything that toggles .flipped
        document.addEventListener('click', function(e){
          // heuristics: after the event loop tick, update
          setTimeout(updateState, 0);
        }, true);
        // Back button logic
        var btn = document.getElementById('global-flip-back');
        if(btn) btn.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          var target = lastFlipped || document.querySelector('.card.flipped');
          if(target) target.classList.remove('flipped');
          // also remove from any others if multiple are flipped
          document.querySelectorAll('.card.flipped').forEach(function(c){ c.classList.remove('flipped'); });
          updateState();
        }, true);
        // Also support ESC key
        document.addEventListener('keydown', function(e){
          if(e.key === 'Escape') {
            var any = document.querySelector('.card.flipped');
            if(any) {
              e.preventDefault();
              document.querySelectorAll('.card.flipped').forEach(function(c){ c.classList.remove('flipped'); });
              updateState();
            }
          }
        });
      })();

</script>

<script>
document.addEventListener('click', function(e){
  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–ª—ñ–∫ –±—É–≤ —É—Å–µ—Ä–µ–¥–∏–Ω—ñ –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –±–æ–∫—É –∫–∞—Ä—Ç–∫–∏
  const back = e.target.closest('.card.flipped .back');
  if(back){
    const card = back.closest('.card');
    if(card){
      card.classList.remove('flipped');
      e.stopPropagation();
    }
  }
}, true);

</script>

<script>
// === Flip height locker: keeps card height equal to the front side ===
function lockFlipSize(card){
  // —è–∫—â–æ —Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à .front/.back, –±–µ—Ä–µ–º–æ .front, —ñ–Ω–∞–∫—à–µ - —Å–∞–º—É –∫–∞—Ä—Ç–∫—É
  const front = card.querySelector('.front') || card;

  const measure = () => {
    // scrollHeight –∫—Ä–∞—â–µ, —è–∫—â–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —î –∫–æ–Ω—Ç–µ–Ω—Ç/–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    const h = Math.ceil(front.scrollHeight);
    card.style.setProperty('--flip-h', h > 0 ? h + 'px' : 'auto');
  };

  // –ø–µ—Ä–≤–∏–Ω–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
  measure();

  // –æ–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É –∫–∞—Ä—Ç–∫–∏/–≤—ñ–∫–Ω–∞
  const ro = new ResizeObserver(() => measure());
  ro.observe(front);
  ro.observe(card);

  // —è–∫—â–æ –Ω–∞ —Ñ—Ä–æ–Ω—Ç—ñ —î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è ‚Äî –ø—ñ—Å–ª—è —ó—Ö –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ–∂ –ø–µ—Ä–µ–º—ñ—Ä—è—î–º–æ
  card.querySelectorAll('img').forEach(img => {
    if (!img.complete) img.addEventListener('load', measure, { once: true });
  });

  // –∑–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–∏–π —Ä–µ—Å–∞–π–∑
  window.addEventListener('resize', measure, { passive: true });
}
</script>

</body>
</html>
